name: Auto Release

on:
    push:
        branches: [main]
        paths: ["package.json"]

jobs:
    release:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Get current version
              id: version
              run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

            - name: Check if tag exists
              id: tag_check
              run: |
                  if git tag -l | grep -q "^v${{ steps.version.outputs.version }}$"; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                  fi

            - name: Create release
              if: steps.tag_check.outputs.exists == 'false'
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: v${{ steps.version.outputs.version }}
                  name: Release v${{ steps.version.outputs.version }}
                  generate_release_notes: true
                  draft: false
                  prerelease: false
